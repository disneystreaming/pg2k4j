sudo: required

env:
  - dockerTag=pg2k4j

services:
  - docker

language: java

install: true

script:
  - nextVersion="$(cat .version | perl -pe 'chomp' | awk -F. "{\$NF = \$NF + 1;} 1" | sed 's/ /./g')"
  - if [ "$TRAVIS_BRANCH" = "master" ]; then revision=$nextVersion; else revision=$TRAVIS_BRANCH; fi
  - revision=$revision mvn clean install jacoco:report
  - bash <(curl -s https://codecov.io/bash)

after_success:
  # Push Bump, Tag, Release
  - if [ "$TRAVIS_BRANCH" = "master" ]; then echo "Bumping version to $nextVersion"; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then echo $nextVersion > .version; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then git checkout $TRAVIS_BRANCH; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then git add .version; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then previousCommitMessage="$(git log -1 --pretty=%B)"; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then git commit -m "[skip travis] Bump Version"; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then git push https://${GH_TOKEN}@github.com/disneystreaming/pg2k4j.git $TRAVIS_BRANCH; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then git tag -a v$nextVersion -m "Release v$nextVersion: $previousCommitMessage"; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then git push https://${GH_TOKEN}@github.com/disneystreaming/pg2k4j.git v$nextVersion; fi
  # Docker Build
  - if [ "$TRAVIS_BRANCH" = "master" ]; then docker build --build-arg version=$revision . -t ${dockerTag}; fi
  # Docker Login
  - if [ "$TRAVIS_BRANCH" = "master" ]; then echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin; fi
  # Docker Tag
  - if [ "$TRAVIS_BRANCH" = "master" ]; then docker tag $dockerTag rkass/pg2k4j:latest; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then docker tag $dockerTag rkass/pg2k4j:v$revision; fi
  # Docker Push
  - if [ "$TRAVIS_BRANCH" = "master" ]; then docker push rkass/pg2k4j:latest; fi
  - if [ "$TRAVIS_BRANCH" = "master" ]; then docker push rkass/pg2k4j:v$revision; fi




